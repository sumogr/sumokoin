name: Continuous_Integration_Testing

on: [push, pull_request]

jobs:
  build-macos-native:
    runs-on: macOS-latest
    steps:
    - uses: actions/checkout@v1
    - name: install dependencies
      run: brew install boost hidapi zmq libpgm ldns expat libunwind-headers protobuf
    - name: build
      run: make -j3

  build-windows-native-msys2:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
    - uses: actions/checkout@v1
    - uses: msys2/setup-msys2@v2
      with:
        update: true
        install: mingw-w64-x86_64-toolchain make mingw-w64-x86_64-cmake mingw-w64-x86_64-libunwind mingw-w64-x86_64-boost mingw-w64-x86_64-openssl mingw-w64-x86_64-zeromq mingw-w64-x86_64-libsodium mingw-w64-x86_64-hidapi mingw-w64-x86_64-protobuf-c mingw-w64-x86_64-libusb git
    - name: build sumokoin
      run: make release-static-win64 -j2

  Windows-32bit-cross-on-bionic:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
    - name: remove bundled boost
      run: sudo rm -rf /usr/local/share/boost
    - name: set apt conf
      run: |
        echo "Acquire::Retries \"3\";" | sudo tee -a /etc/apt/apt.conf.d/80-custom
        echo "Acquire::http::Timeout \"120\";" | sudo tee -a /etc/apt/apt.conf.d/80-custom
        echo "Acquire::ftp::Timeout \"120\";" | sudo tee -a /etc/apt/apt.conf.d/80-custom
    - name: update apt
      run: sudo apt update
    - name: install sumokoin dependencies
      run: sudo apt -y install python3 g++-mingw-w64-i686 gperf autoconf automake libtool cmake pkg-config
    - name: cross compile sumokoin windows 32 bit binaries
      run: make depends target=i686-w64-mingw32 -j 3
    - name: upload binaries
      uses: actions/upload-artifact@v2
      with:
        name: Windows-32bit-release-binaries
        path: build/**/bin/

  build-ubuntu-bionic-native:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
    - name: remove bundled boost
      run: sudo rm -rf /usr/local/share/boost
    - name: set apt conf
      run: |
        echo "Acquire::Retries \"3\";" | sudo tee -a /etc/apt/apt.conf.d/80-custom
        echo "Acquire::http::Timeout \"120\";" | sudo tee -a /etc/apt/apt.conf.d/80-custom
        echo "Acquire::ftp::Timeout \"120\";" | sudo tee -a /etc/apt/apt.conf.d/80-custom
    - name: update apt
      run: sudo apt update
    - name: install sumokoin dependencies
      run: sudo apt -y install build-essential cmake libboost-all-dev miniupnpc libunbound-dev libevent-dev graphviz doxygen libunwind8-dev pkg-config libssl-dev libzmq3-dev libsodium-dev libhidapi-dev libnorm-dev libusb-1.0-0-dev libpgm-dev ccache
    - name: build sumokoin
      run: make -j 3

  cross-build-linux-32bit-binaries-on-xenial:
    runs-on: ubuntu-16.04
    steps:
    - uses: actions/checkout@v1
    - name: remove bundled boost
      run: sudo rm -rf /usr/local/share/boost
    - name: set apt conf
      run: |
        echo "Acquire::Retries \"3\";" | sudo tee -a /etc/apt/apt.conf.d/80-custom
        echo "Acquire::http::Timeout \"120\";" | sudo tee -a /etc/apt/apt.conf.d/80-custom
        echo "Acquire::ftp::Timeout \"120\";" | sudo tee -a /etc/apt/apt.conf.d/80-custom
    - name: update apt and upgrade
      run: |
        sudo apt-get install -y software-properties-common
        sudo add-apt-repository ppa:ubuntu-toolchain-r/test
        sudo apt update
        sudo apt upgrade 
        sudo apt dist-upgrade 
    - name: install sumokoin dependencies
      run: |
        sudo apt -y install gcc-5-base:amd64 libcap2:amd64 ureadahead xz-utils sysv-rc dpkg libhogweed4:amd64 isc-dhcp-common librtmp1:amd64 aptitude-common libsasl2-modules-db:amd64 libglib2.0-0:amd64 libdevmapper1.02.1:amd64 libselinux1:amd64 libatm1:amd64 liblz4-1:amd64 cloud-init libustr-1.0-1:amd64 libnettle6:amd64 libroken18-heimdal:amd64 base-passwd libxapian22v5:amd64 gpgv libxtables11:amd64 locales base-files libnewt0.52:amd64 libsemanage1:amd64 libaudit1:amd64 libgpg-error0:amd64 systemd vim-common libjson-c2:amd64 liblvm2cmd2.02:amd64 libkmod2:amd64 man-db htop libsepol1:amd64 libtasn1-6:amd64 procps bzip2 iputils-ping libboost-iostreams1.58.0:amd64 libslang2:amd64 sensible-utils netcat-openbsd libnfnetlink0:amd64 libncursesw5:amd64 debconf-i18n dirmngr libcryptsetup4:amd64 libstdc++6:amd64 libksba8:amd64 libss2:amd64 tasksel-data libeatmydata1:amd64 ssh-import-id libuuid1:amd64 libdbus-1-3:amd64 zlib1g:amd64 libbsd0:amd64 libexpat1:amd64 libmount1:amd64 libheimntlm0-heimdal:amd64 ncurses-term gettext-base liblzo2-2:amd64 wget libhcrypto4-heimdal:amd64 ncurses-bin isc-dhcp-client hc-utils libwrap0:amd64 gdisk libmnl0:amd64 cron libreadline6:amd64 qemu-guest-agent cpio libgcc1:amd64 libtext-wrapi18n-perl libprocps4:amd64 aptitude libcurl3-gnutls:amd64 libpam-modules-bin libusb-0.1-4:amd64 linux-firmware udev diffutils libblkid1:amd64 libkrb5-3:amd64 libk5crypto3:amd64 libcap-ng0:amd64 cloud-guest-utils dash groff-base libgssapi-krb5-2:amd64 multiarch-support libasn1-8-heimdal:amd64 libsigc++-2.0-0v5:amd64 libidn11:amd64 linux-image-virtual libdebconfclient0:amd64 debianutils libpam-runtime libpopt0:amd64 grub-efi-amd64 perl-base logrotate liblocale-gettext-perl libdrm2:amd64 libdevmapper-event1.02.1:amd64 libheimbase1-heimdal:amd64 systemd-sysv apt iproute2 netbase less libldap-2.4-2:amd64 adduser libtext-charwidth-perl gzip mawk kmod libefivar0:amd64 bash gir1.2-glib-2.0:amd64 mime-support ubuntu-advantage-tools libnih1:amd64 libacl1:amd64 libestr0 at libapparmor1:amd64 linux-modules-4.4.0-193-generic e2fslibs:amd64 libpam-systemd:amd64 libdb5.3:amd64 libssl1.0.0:amd64 xkb-data libfribidi0:amd64 libcap2-bin libassuan0:amd64 libedit2:amd64 libasprintf0v5:amd64 whiptail libfuse2:amd64 libpython3-stdlib:amd64 liblzma5:amd64 libncurses5:amd64 libdbus-glib-1-2:amd64 libplymouth4:amd64 libtinfo5:amd64 libwind0-heimdal:amd64 openssh-client rsyslog sysvinit-utils init ucf net-tools readline-common bsdmainutils iptables coreutils sed e2fsprogs libpcre3:amd64 vim-tiny dbus libyaml-0-2:amd64 libfdisk1:amd64 libc-bin libpam0g:amd64 libbz2-1.0:amd64 init-system-helpers tasksel libsystemd0:amd64 libapt-inst2.0:amd64 libcwidget3v5:amd64 sudo grep lsb-base libgnutls-openssl27:amd64 tar libudev1:amd64 libgdbm3:amd64 util-linux libgnutls30:amd64 bsdutils libhx509-5-heimdal:amd64 libseccomp2:amd64 libkeyutils1:amd64 debconf login libpython3.5:amd64 ubuntu-keyring pciutils libffi6:amd64 patch mount findutils libpci3:amd64 libpython3.5-stdlib:amd64 libkrb5support0:amd64 libcomerr2:amd64 libgirepository-1.0-1:amd64 gnupg libusb-1.0-0:amd64 apt-utils libsqlite3-0:amd64 libpng12-0:amd64 libapt-pkg5.0:amd64 ncurses-base libc6:amd64 libgpm2:amd64 liblvm2app2.2:amd64 libpipeline1:amd64 libpam-modules:amd64 libnpth0:amd64 libpython3.5-minimal:amd64 insserv libp11-kit0:amd64 initscripts libsemanage-common makedev libgmp10:amd64 libtext-iconv-perl libgcrypt20:amd64 grub-efi-amd64-bin hostname libmpdec2:amd64 passwd libattr1:amd64 libkrb5-26-heimdal:amd64 libfreetype6:amd64 libmagic1:amd64 libgssapi3-heimdal:amd64 libsmartcols1:amd64 linux-image-4.4.0-193-generic libreadline5:amd64 gcc-6-base:amd64 ifupdown libsasl2-2:amd64 tzdata
        sudo apt -y install dpkg-dev g++-multilib bc pkg-config libtool autoconf automake gperf build-essential cmake
    - name: cross compile sumokoin bins for linux i686
      run: make depends target=i686-linux-gnu -j 3
    - name: upload binaries
      uses: actions/upload-artifact@v2
      with:
        name: linux-32bit-release-binaries
        path: build/**/bin/

  cross-build-armv7-binaries-on-xenial:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
    - name: remove bundled boost
      run: sudo rm -rf /usr/local/share/boost
    - name: set apt conf
      run: |
        echo "Acquire::Retries \"3\";" | sudo tee -a /etc/apt/apt.conf.d/80-custom
        echo "Acquire::http::Timeout \"120\";" | sudo tee -a /etc/apt/apt.conf.d/80-custom
        echo "Acquire::ftp::Timeout \"120\";" | sudo tee -a /etc/apt/apt.conf.d/80-custom
    - name: update apt
      run: sudo apt update
    - name: install sumokoin dependencies
      run: sudo apt -y install dpkg-dev cmake pkg-config libtool autoconf automake gperf g++-arm-linux-gnueabihf
    - name: cross compile sumokoin bins for arm v7
      run: make depends target=arm-linux-gnueabihf -j 3
    - name: upload binaries
      uses: actions/upload-artifact@v2
      with:
        name: armv7-release-binaries
        path: build/**/bin/

  test-ubuntu:
    needs: build-ubuntu-bionic-native
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
    - name: remove bundled boost
      run: sudo rm -rf /usr/local/share/boost
    - name: set apt conf
      run: |
        echo "Acquire::Retries \"3\";" | sudo tee -a /etc/apt/apt.conf.d/80-custom
        echo "Acquire::http::Timeout \"120\";" | sudo tee -a /etc/apt/apt.conf.d/80-custom
        echo "Acquire::ftp::Timeout \"120\";" | sudo tee -a /etc/apt/apt.conf.d/80-custom
    - name: update apt
      run: sudo apt update
    - name: install sumokoin dependencies
      run: sudo apt -y install build-essential cmake libboost-all-dev miniupnpc libunbound-dev libevent-dev graphviz doxygen libunwind8-dev pkg-config libssl-dev libzmq3-dev libsodium-dev libhidapi-dev libnorm-dev libusb-1.0-0-dev libpgm-dev
    - name: install requests
      run: pip install requests
    - name: tests
      env:
        CTEST_OUTPUT_ON_FAILURE: ON
      run: make release-test -j 3
